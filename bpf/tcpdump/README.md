
# Tcpdump/pcap 和 BPF

## 二层以太网帧结构

```bash
|       0-6       |      6-12       |     12-14       |
+-----------------+-----------------+-----------------+----------------------+--------------------+
| Dst MAC(6Bytes) | Src MAC(6Bytes) | EthType(2Bytes) |   Data(46-1500Bytes) | FrameChech(4Bytes) |
+-----------------+-----------------+-----------------+----------------------+--------------------+
|                 Packet Header                       |            Data and CRC                   |
```

## tcpdump 命令

```bash
$ sudo tcpdump -d ip and tcp port 80
(000) ldh      [12]	--累加器在偏移量12处加载一个 16位(以太网类型字段)
(001) jeq      #0x800           jt 2	jf 12	--返回当前的以太网类型字段，0x800是IPv4
(002) ldb      [23]	--14+9：IPv4头的协议位置
(003) jeq      #0x6             jt 4	jf 12	--0x6是TCP
(004) ldh      [20]	--段偏移量
(005) jset     #0x1fff          jt 12	jf 6	--查看最后13字节
(006) ldxb     4*([14]&0xf)	--加载
(007) ldh      [x + 14]
(008) jeq      #0x50            jt 11	jf 9
(009) ldh      [x + 16]
(010) jeq      #0x50            jt 11	jf 12
(011) ret      #262144
(012) ret      #0
```


