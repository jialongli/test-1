全关联型Cache

全关联型Cache 是指主存中的任何一块内存都可以映射到Cache 中的任意一块位置上。
在Cache 中，需要建立一个目录表，目录表的每个表项都有三部分组成：内存地址、Cache
块号和一个有效位。当处理器需要访问某个内存地址时，首先通过该目录表查询是否该内容
缓存在Cache 中，具体过程如图2-5 所示

首先，用内存的块地址A 在Cache 的目录表中进行查询，如果找到等值的内存块地址，
检查有效位是否有效，只有有效的情况下，才能通过Cache 块号在Cache 中找到缓存的内
存，并且加上块内地址B，找到相应数据，这时则称为Cache 命中，处理器拿到数据返回；
否则称为不命中，处理器则需要在内存中读取相应的数据。
可以看出，使用全关联型Cache，块的冲突最小（没有冲突），Cache 的利用率也高，但
是需要一个访问速度很快的相联存储器。随着Cache 容量的增加，其电路设计变得十分
复杂，因此只有容量很小的Cache 才会设计成全关联型的（如一些英特尔处理器中的TLB
Cache）。

------------------------------------

直接关联型Cache
直接关联型Cache 是指主存中的一块内存只能映射到Cache 的一个特定的块中。假设
一个Cache 中总共存在N 个Cache line，那么内存被分成N 等分，其中每一等分对应一个
Cache line。举个简单的例子，假设Cache 的大小是2K，而一个Cache line 的大小是64B，
那么就一共有2K/64B=32 个Cache line，那么对应我们的内存，第1 块（地址0 ～ 63），第
33 块（地址64*32 ～ 64*33-1），以及第（N*32+1）块（地址64*（N-1）～ 64*N-1）都被映
射到Cache 第一块中；同理，第2 块，第34 块，以及第（N*32+2）块都被映射到Cache 第
二块中；可以依次类推其他内存块。

直接关联型Cache 的目录表只有两部分组成：区号和有效位。其查找过程如图2-6 所
示。首先，内存地址被分成三部分：区号A、块号B 和块内地址C。根据区号A 在目录表中
找到完全相等的区号，并且在有效位有效的情况下，说明该数据在Cache 中，然后通过内存
地址的块号B 获得在Cache 中的块地址，加上块内地址C，最终找到数据。如果在目录表中
找不到相等的区号，或者有效位无效的情况下，则说明该内容不在Cache 中，需要到内存中
读取。

可以看出，直接关联是一种很“死”的映射方法，当映射到同一个Cache 块的多个内存
块同时需要缓存在Cache 中时，只有一个内存块能够缓存，其他块需要被“淘汰”掉。因此，
直接关联型命中率是最低的，但是其实现方式最为简单，匹配速度也最快。

----------------------------------------

组关联型Cache
组关联型Cache 是目前Cache 中用的比较广泛的一种方式，是前两种Cache 的折中形
式。在这种方式下，内存被分为很多组，一个组的大小为多个Cache line 的大小，一个组映
射到对应的多个连续的Cache line，也就是一个Cache 组，并且该组内的任意一块可以映射
到对应Cache 组的任意一个。可以看出，在组外，其采用直接关联型Cache 的映射方式，而
在组内，则采用全关联型Cache 的映射方式。
假设有一个4 路组关联型Cache，其大小为1M，一个Cache line 的大小为64B，那么
总共有16K 个Cache line，但是在4 路组关联的情况下，我们并不是简简单单拥有16K 个
Cache line，而是拥有了4K 个组，每个组有4 个Cache line。一个内存单元可以缓存到它所
对应的组中的任意一个Cache line 中去。
图2-7 以4 路组关联型Cache 为例介绍其在Cache 中的查找过程。目录表由三部分组
成，分别是“区号+ 块号”、Cache 块号和有效位。当收到一个内存地址时，该地址被分成四
部分：区号A、组号B、块号C 和块内地址D。首先，根据组号B 按地址查找到一组目录表
项，在4 路组关联中，则有四个表项，每个表项都有可能存放该内存块；然后，根据区号A
和块号C 在该组表项中进行关联查找（即并行查找，为了提高效率），如果匹配且有效位有
效，则表明该数据块缓存在Cache 中，得到Cache 块号，加上块内地址D，可以得到该内存
地址在Cache 中映射的地址，得到数据；如果没有找到匹配项或者有效位无效，则表示该内
存块不在Cache 中，需要处理器到内存中读取。
实际上，直接关联型Cache 和全关联型Cache 只是组关联型Cache 的特殊情况，当组内
Cache Line 数目为1 时，即为直接关联型Cache。而当组内Cache Line 数目和Cache 大小相
等时，即整个Cache 只有一个组，这成为全关联型Cache。




